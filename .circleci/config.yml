version: 2.1
jobs:
  build:
#    working_directory: /usr/src/app/
    docker: # run the steps with Docker
      - image: cimg/node:16.13.2
    environment:
      HOST: "127.0.0.1"
      DB_PORT: 5432
      USER: "leankyr"
      PASS: "lalala"
      DB: "CarsDB"
      SERVER: "http://localhost:3000"
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: lalala
      POSTGRES_DB: postgres
      APP_DB_USER: postgres
      APP_DB_PASS: lalala
      APP_DB_NAME: postgres
    steps: # a collection of executable commands
      - checkout
      - run:
          name: Install project dependencies
          command: npm install
      - run:
          name: Update Repos
          command: sudo apt update
      - run:
          name: Install Postgres
          command: sudo apt -y install postgresql-12
      - run:
          name: Restart Postgres Service
          command: sudo /etc/init.d/postgresql restart
      - run:
          name: Make file executable
          command: chmod +x ./src/database/migrations/02-init.sh
      - run:
          name: Create DB
          command: sh ./src/database/migrations/02-init.sh
      - run:
          name: Run tests
          command: npm test
